<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Hospital Delivery</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {font-family:Segoe UI; margin:0; background:#f2f6f9}
header {background:#0078d7;color:white;padding:1rem;text-align:center;position:relative}
#notificacion {background:red;color:white;border-radius:50%;padding:5px 10px;position:absolute;right:20px;top:10px;display:none}
main {max-width:900px;margin:auto;background:white;border-radius:12px;padding:2rem;margin-top:20px}

input,select,button {padding:10px;border-radius:6px;border:1px solid #ccc}
button {background:#0078d7;color:white;cursor:pointer}
section {display:none}

.categoria {background:#eaf2fa;border-radius:8px;padding:1rem;margin-top:10px}
.producto {display:flex;justify-content:space-between;margin:6px 0}
.pedidoBox {background:#f7fafc;padding:1rem;margin-top:10px;border-radius:8px}
.logout{text-align:right}
.stockEdit{width:80px}
.alertaStock{color:red;font-weight:bold}
#entregados {margin-top:20px;}
#agregarArticulo {margin-top:20px; padding:10px; border:1px solid #ccc; border-radius:8px; background:#f7f7f7;}

/* ===== LOGIN BONITO ===== */
#loginSection, #registroSection {
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:80vh;
}

.form-card {
  background:white;
  padding:2rem;
  width:100%;
  max-width:380px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.1);
  text-align:center;
}

.form-card h2 {
  margin-bottom:1rem;
  color:#0078d7;
}

.form-card input,
.form-card select {
  width:100%;
  margin-bottom:12px;
  padding:12px;
  border-radius:10px;
  border:1px solid #ddd;
}

.form-card button {
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#0078d7;
  color:white;
  font-size:16px;
}

.form-card a {
  color:#0078d7;
  text-decoration:none;
}
</style>
</head>

<body>

<header>
<h1>üè• Hospital Delivery</h1>
<span id="notificacion">0</span>
</header>

<main>

<div class="logout" id="logoutSection">
<button onclick="cerrarSesion()">Cerrar sesi√≥n</button>
</div>

<!-- LOGIN -->
<section id="loginSection">
<div class="form-card">
<h2>Bienvenido</h2>
<form id="loginForm">
<input type="email" id="loginCorreo" placeholder="Correo" required>
<input type="password" id="loginPass" placeholder="Contrase√±a" required>
<button>Entrar</button>
</form>
<p><a href="#" onclick="mostrarRegistro()">Crear cuenta</a></p>
</div>
</section>

<!-- REGISTRO -->
<section id="registroSection">
<div class="form-card">
<h2>Crear cuenta</h2>
<form id="registroForm">
<input id="nombre" placeholder="Nombre completo" required>
<input type="email" id="correo" placeholder="Correo" required>
<input type="password" id="pass" placeholder="Contrase√±a" required>
<select id="rol" required>
<option value="">Selecciona rol</option>
<option value="doctor">Doctor</option>
<option value="paciente">Paciente</option>
<option value="enfermero">Enfermero</option>
</select>
<button>Registrarse</button>
</form>
<p><a href="#" onclick="loginSection.style.display='block';registroSection.style.display='none';">Ya tengo cuenta</a></p>
</div>
</section>

<!-- CAT√ÅLOGO -->
<section id="productos">
<h2>Cat√°logo</h2>
<div id="listaCategorias"></div>

<label>Selecciona enfermero:</label>
<select id="selectEnfermero"></select>
<br><br>
<button onclick="enviarPedido()">Enviar pedido</button>
</section>

<!-- PANEL ENFERMERO -->
<section id="panelPedidos">
<h2>Panel Enfermero</h2>

<h3>Inventario</h3>
<div id="listaInventario"></div>

<h3>Pedidos Pendientes</h3>
<div id="listaPedidos"></div>

<h3 id="entregados">Pedidos Entregados</h3>
<div id="listaEntregados"></div>

<div id="agregarArticulo">
<h3>Agregar Art√≠culo</h3>
<input type="text" id="articuloNombre" placeholder="Nombre">
<input type="text" id="articuloCategoria" placeholder="Categor√≠a">
<input type="number" id="articuloExistencias" placeholder="Existencias" min="0">
<button onclick="agregarArticulo()">Agregar</button>
</div>
</section>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, browserSessionPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, getDoc, getDocs, query, where, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyDpPKkgBLLDv2QoG9ObGfObZd5S-auUKhg",
authDomain: "enfermeria-c2edc.firebaseapp.com",
projectId: "enfermeria-c2edc",
storageBucket: "enfermeria-c2edc.appspot.com",
messagingSenderId: "955092319230",
appId: "1:955092319230:web:66b5f8d168f6748ce45eaf"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

setPersistence(auth, browserSessionPersistence);

const loginSection = document.getElementById("loginSection");
const registroSection = document.getElementById("registroSection");
const productos = document.getElementById("productos");
const panelPedidos = document.getElementById("panelPedidos");
const logoutSection = document.getElementById("logoutSection");
const notificacion = document.getElementById("notificacion");

const listaCategorias = document.getElementById("listaCategorias");
const listaInventario = document.getElementById("listaInventario");
const listaPedidos = document.getElementById("listaPedidos");
const listaEntregados = document.getElementById("listaEntregados");
const selectEnfermero = document.getElementById("selectEnfermero");

const articuloNombre = document.getElementById("articuloNombre");
const articuloCategoria = document.getElementById("articuloCategoria");
const articuloExistencias = document.getElementById("articuloExistencias");

function ocultarTodo(){
loginSection.style.display="none";
registroSection.style.display="none";
productos.style.display="none";
panelPedidos.style.display="none";
logoutSection.style.display="none";
}

registroForm.onsubmit = async e=>{
e.preventDefault();
const cred = await createUserWithEmailAndPassword(auth, correo.value, pass.value);
await setDoc(doc(db,"usuarios",cred.user.uid),{nombre:nombre.value,correo:correo.value,rol:rol.value});
alert("Cuenta creada ‚úÖ");
registroSection.style.display="none";
loginSection.style.display="flex";
};

loginForm.onsubmit = async e=>{
e.preventDefault();
await signInWithEmailAndPassword(auth, loginCorreo.value, loginPass.value);
};

onAuthStateChanged(auth, async user=>{
ocultarTodo();
if(!user){loginSection.style.display="flex"; return;}
logoutSection.style.display="block";

const ref = doc(db,"usuarios",user.uid);
const snap = await getDoc(ref);
if(!snap.exists()){alert("Cuenta mal registrada"); await signOut(auth); return;}
const u = snap.data();

if(u.rol==="enfermero"){panelPedidos.style.display="block"; cargarInventarioEditable(); cargarPedidos(u.correo);}
else{productos.style.display="block"; cargarCatalogo(); cargarEnfermeros();}
});

if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();

function mostrarNotificacion(t,m){
if(Notification.permission==="granted"){new Notification(t,{body:m});}
new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();
}

function bloquearSimbolos(input){
input.addEventListener("keypress",e=>{
if(["+","-","e","E","."].includes(e.key)) e.preventDefault();
});
input.addEventListener("input",()=>{input.value=input.value.replace(/\D/g,"");});
}

function cargarCatalogo(){
onSnapshot(collection(db,"inventario"),snap=>{
listaCategorias.innerHTML="";
let cats={};
snap.forEach(d=>{
let p=d.data();
if(!cats[p.categoria]) cats[p.categoria]=[];
cats[p.categoria].push({...p,id:d.id});
});
Object.entries(cats).forEach(([cat,arr])=>{
let div=document.createElement("div");
div.className="categoria";
div.innerHTML=`<h3>${cat}</h3>`;
arr.forEach(p=>{
let aviso=p.existencias<5?"<span class='alertaStock'>‚ö† casi agotado</span>":"";
div.innerHTML+=`
<div class="producto">
<span>${p.nombre}${aviso} (Disp:${p.existencias})</span>
<input type="number" min="0" max="${p.existencias}" value="0" class="cantidad">
</div>`;
});
listaCategorias.appendChild(div);
});
document.querySelectorAll(".cantidad").forEach(bloquearSimbolos);
});
}

function cargarInventarioEditable(){
onSnapshot(collection(db,"inventario"),snap=>{
listaInventario.innerHTML="";
snap.forEach(d=>{
let p=d.data();
listaInventario.innerHTML+=`
<div class="producto">
${p.nombre}
<input class="stockEdit" type="number" min="0" value="${p.existencias}"
onchange="actualizarStock('${d.id}',this.value)">
</div>`;
});
});
}

window.actualizarStock = async (id,v)=>{
v=parseInt(v)||0;
await updateDoc(doc(db,"inventario",id),{existencias:v});
};

window.agregarArticulo = async ()=>{
const nombre=articuloNombre.value.trim();
const categoria=articuloCategoria.value.trim();
const existencias=parseInt(articuloExistencias.value);
if(!nombre||!categoria||isNaN(existencias)||existencias<0) return alert("Datos inv√°lidos");
await addDoc(collection(db,"inventario"),{nombre,categoria,existencias});
alert("Art√≠culo agregado ‚úÖ");
articuloNombre.value=""; articuloCategoria.value=""; articuloExistencias.value="";
};

function cargarEnfermeros(){
onSnapshot(query(collection(db,"usuarios"),where("rol","==","enfermero")),snap=>{
selectEnfermero.innerHTML="";
snap.forEach(d=>{
let u=d.data();
selectEnfermero.innerHTML+=`<option value="${u.correo}">${u.nombre}</option>`;
});
});
}

window.enviarPedido = async ()=>{
const para=selectEnfermero.value;
if(!para) return alert("Selecciona enfermero");
let items=[];
let prods=document.querySelectorAll(".producto");
for(let p of prods){
let nom=p.querySelector("span").innerText.split(" (")[0];
let cant=parseInt(p.querySelector("input").value);
if(!cant||cant<=0) continue;
const q=query(collection(db,"inventario"),where("nombre","==",nom));
const snap=await getDocs(q);
const docInv=snap.docs[0];
const data=docInv.data();
if(cant>data.existencias) return alert("Stock insuficiente");
await updateDoc(doc(db,"inventario",docInv.id),{existencias:data.existencias-cant});
items.push({nombre:nom,cantidad:cant});
}
if(!items.length) return alert("No seleccionaste art√≠culos");
await addDoc(collection(db,"pedidos"),{de:auth.currentUser.email,para,items,fecha:new Date().toLocaleString(),estado:"pendiente"});
alert("Pedido enviado ‚úÖ");
};

function cargarPedidos(correo){
onSnapshot(query(collection(db,"pedidos"),where("para","==",correo)),snap=>{
listaPedidos.innerHTML=""; listaEntregados.innerHTML="";
let pendientes=0;
snap.forEach(d=>{
let p=d.data();
if(p.estado==="pendiente"){
pendientes++;
listaPedidos.innerHTML+=`
<div class="pedidoBox">
<b>${p.fecha}</b><br>${p.items.map(i=>`${i.nombre} (${i.cantidad})`).join("<br>")}
<br><br>
<button onclick="entregarPedido('${d.id}')">‚úî Entregado</button>
<button onclick="borrarPedido('${d.id}')">üóë Eliminar</button>
</div>`;
}else if(p.estado==="entregado"){
listaEntregados.innerHTML+=`
<div class="pedidoBox">
<b>${p.fecha}</b><br>${p.items.map(i=>`${i.nombre} (${i.cantidad})`).join("<br>")}
</div>`;
}
});
notificacion.style.display=pendientes?"inline-block":"none";
notificacion.innerText=pendientes;
if(pendientes) mostrarNotificacion("üì¶ Nuevo pedido",`Tienes ${pendientes} pendientes`);
});
}

window.entregarPedido=async id=>{await updateDoc(doc(db,"pedidos",id),{estado:"entregado"});};

window.borrarPedido=async id=>{
if(confirm("¬øEliminar pedido?")) await deleteDoc(doc(db,"pedidos",id));
};

window.cerrarSesion=()=>{signOut(auth); location.reload();};
window.mostrarRegistro=()=>{loginSection.style.display="none"; registroSection.style.display="flex";};
</script>

</body>
</html>
