<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Hospital Delivery</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ===== FONDO ===== */
body {
  font-family:Segoe UI;
  margin:0;
  background:linear-gradient(120deg,#0078d7,#67c6ff);
}

/* ===== GENERAL ===== */
header {
  background:rgba(0,0,0,.15);
  color:white;
  padding:1rem;
  text-align:center;
  position:fixed;
  width:100%;
  top:0;
}

#notificacion {
  background:red;
  color:white;
  border-radius:50%;
  padding:4px 9px;
  position:absolute;
  right:20px;
  top:10px;
  display:none;
}

main {
  max-width:900px;
  margin:auto;
  padding-top:90px;
}

/* ===== LOGIN TARJETA ===== */
#loginSection,#registroSection {
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.form-card {
  background:rgba(255,255,255,.98);
  padding:2.5rem;
  width:100%;
  max-width:420px;
  border-radius:25px;
  box-shadow:0 20px 50px rgba(0,0,0,.25);
  animation:fade .6s ease;
}

@keyframes fade {
  from{opacity:0;transform:translateY(20px);}
  to{opacity:1;transform:translateY(0);}
}

.form-card h2 {
  text-align:center;
  color:#0078d7;
  margin-bottom:20px;
}

.form-card input, .form-card select {
  width:100%;
  padding:14px;
  margin-bottom:14px;
  border-radius:15px;
  border:1px solid #ddd;
}

.form-card input:focus {
  outline:none;
  border-color:#4aa3ff;
}

.form-card button {
  width:100%;
  padding:14px;
  border:none;
  border-radius:18px;
  background:linear-gradient(45deg,#0078d7,#4aa3ff);
  color:white;
  font-size:16px;
  cursor:pointer;
}

.form-card button:hover {transform:scale(1.05);}

.form-card a {
  display:block;
  text-align:center;
  margin-top:15px;
  color:#0078d7;
  font-weight:bold;
  text-decoration:none;
}

/* ===== CONTENIDO ===== */
section {display:none;}
.categoria {background:#eaf2fa;border-radius:12px;padding:1rem;margin-top:10px}
.producto {display:flex;justify-content:space-between;margin:6px 0}
.pedidoBox {background:#f7fafc;padding:1rem;margin-top:10px;border-radius:8px}
.logout{text-align:right}
.stockEdit{width:80px}
.alertaStock{color:red;font-weight:bold}
#entregados{margin-top:20px;}
#agregarArticulo{margin-top:20px;padding:10px;background:#f7f7f7;border-radius:10px}
button{background:#0078d7;color:white;border:none;border-radius:8px;padding:10px}
</style>
</head>

<body>

<header>
<h1>üè• Hospital Delivery</h1>
<span id="notificacion">0</span>
</header>

<main>

<div class="logout" id="logoutSection">
<button onclick="cerrarSesion()">Cerrar sesi√≥n</button>
</div>

<!-- LOGIN -->
<section id="loginSection">
<div class="form-card">
<h2>Hospital Delivery</h2>
<form id="loginForm">
<input type="email" id="loginCorreo" placeholder="Correo electr√≥nico" required>
<input type="password" id="loginPass" placeholder="Contrase√±a" required>
<button>Iniciar sesi√≥n</button>
</form>
<a href="#" onclick="mostrarRegistro()">Crear cuenta</a>
</div>
</section>

<!-- REGISTRO -->
<section id="registroSection">
<div class="form-card">
<h2>Crear cuenta</h2>
<form id="registroForm">
<input id="nombre" placeholder="Nombre completo" required>
<input type="email" id="correo" placeholder="Correo electr√≥nico" required>
<input type="password" id="pass" placeholder="Contrase√±a" required>
<select id="rol" required>
<option value="">Selecciona tu rol</option>
<option value="doctor">Doctor</option>
<option value="paciente">Paciente</option>
<option value="enfermero">Enfermero</option>
</select>
<button>Registrarse</button>
</form>
<a href="#" onclick="loginSection.style.display='flex';registroSection.style.display='none';">Ya tengo cuenta</a>
</div>
</section>

<!-- CAT√ÅLOGO -->
<section id="productos">
<h2>Cat√°logo</h2>
<div id="listaCategorias"></div>
<label>Selecciona enfermero:</label>
<select id="selectEnfermero"></select>
<br><br>
<button onclick="enviarPedido()">Enviar pedido</button>
</section>

<!-- PANEL ENFERMERO -->
<section id="panelPedidos">
<h2>Panel Enfermero</h2>
<h3>Inventario</h3><div id="listaInventario"></div>
<h3>Pedidos Pendientes</h3><div id="listaPedidos"></div>
<h3 id="entregados">Pedidos Entregados</h3><div id="listaEntregados"></div>

<div id="agregarArticulo">
<h3>Agregar Art√≠culo</h3>
<input type="text" id="articuloNombre" placeholder="Nombre">
<input type="text" id="articuloCategoria" placeholder="Categor√≠a">
<input type="number" id="articuloExistencias" placeholder="Existencias" min="0">
<button onclick="agregarArticulo()">Agregar</button>
</div>
</section>

</main>

<script type="module">
/* -------------- IMPORTS -------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, browserSessionPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, getDoc, getDocs, query, where, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* -------------- FIREBASE CONFIG -------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDpPKkgBLLDv2QoG9ObGfObZd5S-auUKhg",
  authDomain: "enfermeria-c2edc.firebaseapp.com",
  projectId: "enfermeria-c2edc",
  storageBucket: "enfermeria-c2edc.appspot.com",
  messagingSenderId: "955092319230",
  appId: "1:955092319230:web:66b5f8d168f6748ce45eaf"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

/* -------------- SESSION PER TAB -------------- */
setPersistence(auth, browserSessionPersistence).catch(err => console.error(err));

/* -------------- ELEMENTOS UI -------------- */
const loginSection = document.getElementById("loginSection");
const registroSection = document.getElementById("registroSection");
const productos = document.getElementById("productos");
const panelPedidos = document.getElementById("panelPedidos");
const logoutSection = document.getElementById("logoutSection");
const notificacion = document.getElementById("notificacion");

const listaCategorias = document.getElementById("listaCategorias");
const listaInventario = document.getElementById("listaInventario");
const listaPedidos = document.getElementById("listaPedidos");
const listaEntregados = document.getElementById("listaEntregados");
const selectEnfermero = document.getElementById("selectEnfermero");

const articuloNombre = document.getElementById("articuloNombre");
const articuloCategoria = document.getElementById("articuloCategoria");
const articuloExistencias = document.getElementById("articuloExistencias");

/* -------------- UTIL -------------- */
function ocultarTodo(){
  loginSection.style.display="none";
  registroSection.style.display="none";
  productos.style.display="none";
  panelPedidos.style.display="none";
  logoutSection.style.display="none";
}

/* -------------- NOTIFICACIONES Y SONIDO -------------- */
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}
function mostrarNotificacion(titulo, mensaje) {
  if (Notification.permission === "granted") {
    try { new Notification(titulo, { body: mensaje }); } catch(e) {}
  }
  // sonido
  try { new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play(); } catch(e) {}
}

/* -------------- BLOQUEO DE S√çMBOLOS -------------- */
function bloquearSimbolos(input){
  input.addEventListener("keypress", e=>{
    if (["+","-","e","E","."].includes(e.key)) e.preventDefault();
  });
  input.addEventListener("input", ()=>{ input.value = input.value.replace(/\D/g,""); });
}

/* -------------- REGISTRO -------------- */
registroForm.onsubmit = async e=>{
  e.preventDefault();
  const cred = await createUserWithEmailAndPassword(auth, correo.value, pass.value);
  await setDoc(doc(db,"usuarios",cred.user.uid),{nombre:nombre.value, correo:correo.value, rol:rol.value});
  alert("Cuenta creada ‚úÖ");
  registroSection.style.display="none";
  loginSection.style.display="flex";
};

/* -------------- LOGIN -------------- */
loginForm.onsubmit = async e=>{
  e.preventDefault();
  await signInWithEmailAndPassword(auth, loginCorreo.value, loginPass.value);
};

/* -------------- CARGA DE SESI√ìN -------------- */
onAuthStateChanged(auth, async user=>{
  ocultarTodo();
  if(!user){
    loginSection.style.display="flex";
    return;
  }

  logoutSection.style.display="block";

  const ref = doc(db,"usuarios",user.uid);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    alert("Cuenta mal registrada");
    await signOut(auth);
    return;
  }

  const u = snap.data();

  if(u.rol === "enfermero"){
    panelPedidos.style.display = "block";
    cargarInventarioEditable();
    cargarPedidos(u.correo);
  }else{
    productos.style.display = "block";
    cargarCatalogo();
    cargarEnfermeros();
  }
});

/* -------------- CATALOGO (clientes) -------------- */
function cargarCatalogo(){
  onSnapshot(collection(db,"inventario"), snap=>{
    listaCategorias.innerHTML="";
    let cats={};

    snap.forEach(d=>{
      let p = d.data();
      if(!cats[p.categoria]) cats[p.categoria]=[];
      cats[p.categoria].push({...p,id:d.id});
    });

    Object.entries(cats).forEach(([cat,arr])=>{
      let div = document.createElement("div");
      div.className = "categoria";
      div.innerHTML = `<h3>${cat}</h3>`;

      arr.forEach(p=>{
        let aviso = p.existencias<5 ? "<span class='alertaStock'>‚ö† casi agotado</span>" : "";
        div.innerHTML += `
          <div class="producto">
            <span>${p.nombre}${aviso} (Disp:${p.existencias})</span>
            <input class="cantidad" type="number" min="0" max="${p.existencias}" value="0">
          </div>`;
      });

      listaCategorias.appendChild(div);
    });

    // aplicar bloqueo de s√≠mbolos a todos los inputs de cantidad
    document.querySelectorAll(".cantidad").forEach(inp => bloquearSimbolos(inp));
  });
}

/* -------------- INVENTARIO EDITABLE (enfermero) -------------- */
function cargarInventarioEditable(){
  onSnapshot(collection(db,"inventario"), snap=>{
    listaInventario.innerHTML = "";
    snap.forEach(d=>{
      let p = d.data();
      listaInventario.innerHTML += `
        <div class="producto">
          ${p.nombre}
          <input class="stockEdit" type="number" min="0" value="${p.existencias}" onchange="actualizarStock('${d.id}',this.value)">
        </div>`;
    });
  });
}

window.actualizarStock = async (id,v) => {
  v = parseInt(v) || 0;
  await updateDoc(doc(db,"inventario",id), { existencias: v });
};

/* -------------- AGREGAR ART√çCULO (enfermero) -------------- */
window.agregarArticulo = async ()=>{
  const nombre = articuloNombre.value.trim();
  const categoria = articuloCategoria.value.trim();
  const existencias = parseInt(articuloExistencias.value);

  if(!nombre || !categoria || isNaN(existencias) || existencias < 0){
    return alert("Completa todos los campos correctamente");
  }

  await addDoc(collection(db,"inventario"), { nombre, categoria, existencias });
  alert("Art√≠culo agregado ‚úÖ");
  articuloNombre.value=""; articuloCategoria.value=""; articuloExistencias.value="";
};

/* -------------- CARGAR ENFERMEROS (select) -------------- */
function cargarEnfermeros(){
  onSnapshot(query(collection(db,"usuarios"), where("rol","==","enfermero")), snap=>{
    selectEnfermero.innerHTML = "";
    snap.forEach(d=>{
      let u = d.data();
      selectEnfermero.innerHTML += `<option value="${u.correo}">${u.nombre}</option>`;
    });
  });
}

/* -------------- ENVIAR PEDIDO -------------- */
window.enviarPedido = async ()=>{
  const para = selectEnfermero.value;
  if(!para) return alert("Selecciona enfermero");

  let items = [];
  let prods = document.querySelectorAll(".producto");

  for(let p of prods){
    // si no tiene input (ej. inventario list) saltar
    let inp = p.querySelector("input");
    if(!inp) continue;

    let nom = p.querySelector("span").innerText.split(" (")[0];
    let cant = parseInt(inp.value) || 0;

    if(!cant || cant <= 0) continue;

    const q = query(collection(db,"inventario"), where("nombre","==",nom));
    const snap = await getDocs(q);

    if(snap.empty) return alert("No encontrado: "+nom);

    const docInv = snap.docs[0];
    const data = docInv.data();

    if(cant > data.existencias) return alert("Stock insuficiente de "+nom);

    await updateDoc(doc(db,"inventario",docInv.id), { existencias: data.existencias - cant });

    items.push({ nombre: nom, cantidad: cant });
  }

  if(!items.length) return alert("No seleccionaste art√≠culos");

  await addDoc(collection(db,"pedidos"), {
    de: auth.currentUser.email,
    para,
    items,
    fecha: new Date().toLocaleString(),
    estado: "pendiente"
  });

  alert("Pedido enviado ‚úÖ");
};

/* -------------- CARGAR PEDIDOS (enfermero) -------------- */
function cargarPedidos(correo){
  onSnapshot(query(collection(db,"pedidos"), where("para","==",correo)), snap=>{
    listaPedidos.innerHTML = "";
    listaEntregados.innerHTML = "";
    let pendientes = 0;

    snap.forEach(d=>{
      let p = d.data();
      if(p.estado === "pendiente"){
        pendientes++;
        listaPedidos.innerHTML += `
          <div class="pedidoBox">
            <b>${p.fecha}</b><br>
            ${p.items.map(i=>`${i.nombre} (${i.cantidad})`).join("<br>")}
            <br><br>
            <button onclick="entregarPedido('${d.id}')">‚úî Entregado</button>
            <button onclick="borrarPedido('${d.id}')">üóë Eliminar</button>
          </div>`;
      } else if(p.estado === "entregado"){
        listaEntregados.innerHTML += `
          <div class="pedidoBox">
            <b>${p.fecha}</b><br>
            ${p.items.map(i=>`${i.nombre} (${i.cantidad})`).join("<br>")}
          </div>`;
      }
    });

    notificacion.style.display = pendientes ? "inline-block" : "none";
    notificacion.innerText = pendientes;

    if(pendientes > 0) mostrarNotificacion("üì¶ Nuevo pedido", `Tienes ${pendientes} pedido(s) pendiente(s)`);
  });
}

/* -------------- ENTREGAR / BORRAR -------------- */
window.entregarPedido = async id => {
  await updateDoc(doc(db,"pedidos",id), { estado: "entregado" });
  // la UI se actualiza autom√°ticamente por onSnapshot
};

window.borrarPedido = async id => {
  if(confirm("¬øSeguro que quieres eliminar este pedido?")){
    await deleteDoc(doc(db,"pedidos",id));
    alert("Pedido eliminado");
  }
};

/* -------------- SESI√ìN / UI helpers -------------- */
window.cerrarSesion = ()=> {
  signOut(auth);
  location.reload();
};

window.mostrarRegistro = ()=> {
  loginSection.style.display="none";
  registroSection.style.display="flex";
};

/* -------------- FIN DEL SCRIPT -------------- */
</script>
</body>
</html>
